From d1d20026bc0b4fb6279482f24c107654babaeffc Mon Sep 17 00:00:00 2001
From: Seal <info@sealsecurity.io>
Date: Thu, 21 Nov 2024 18:32:27 +0200
Subject: [PATCH] CVE-2024-38428

---
 src/url.c | 35 +++++++++++++++++++++++++++++------
 1 file changed, 29 insertions(+), 6 deletions(-)

diff --git a/src/url.c b/src/url.c
index 5cc37a3..aedb3b2 100644
--- a/src/url.c
+++ b/src/url.c
@@ -42,6 +42,7 @@ as that of the covered work.  */
 #include "utils.h"
 #include "url.h"
 #include "host.h"  /* for is_valid_ipv6_address */
+#include "c-ctype.h"
 
 #ifdef __VMS
 #include "vms.h"
@@ -484,12 +485,34 @@ scheme_disable (enum url_scheme scheme)
 static const char *
 url_skip_credentials (const char *url)
 {
-  /* Look for '@' that comes before terminators, such as '/', '?',
-     '#', or ';'.  */
-  const char *p = (const char *)strpbrk (url, "@/?#;");
-  if (!p || *p != '@')
-    return url;
-  return p + 1;
+  /*
+ * This whole file implements https://www.rfc-editor.org/rfc/rfc2396 .
+ * RFC 2396 is outdated since 2005 and needs a rewrite or a thorough re-visit.
+ *
+ * The RFC says
+ * server        = [ [ userinfo "@" ] hostport ]
+ * userinfo      = *( unreserved | escaped | ";" | ":" | "&" | "=" | "+" | "$" | "," )
+ * unreserved    = alphanum | mark
+ * mark          = "-" | "_" | "." | "!" | "~" | "*" | "'" | "(" | ")"
+ */
+  const char *p;
+  static const char *allowed = "-_.!~*'();:&=+$,";
+  for (p = url; *p; p++)
+    {
+      if (c_isalnum(*p))
+        continue;
+      if (strchr(allowed, *p))
+        continue;
+      if (*p == '%' && c_isxdigit(p[1]) && c_isxdigit(p[2]))
+        {
+          p += 2;
+          continue;
+        }
+      if (*p == '@')
+        return p + 1;
+      break;
+    }
+  return url;
 }
 
 /* Parse credentials contained in [BEG, END).  The region is expected
-- 
2.39.5

